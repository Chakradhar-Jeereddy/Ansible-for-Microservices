---
- hosts: cart
  gather_facts: no
  become: yes
  tasks:
   - name: disable default module
     command: dnf module disable nodejs -y

   - name: enable module nodejs20
     command: dnf module enable nodejs:20 -y
   
   - name: install nodejs
     package:
      name: nodejs
      state: present

   - name: Create 'roboshop' with no login shell
     ansible.builtin.user:
        name: roboshop
        comment: "roboshop system user"
        shell: /sbin/nologin #  /sbin/nologin
        create_home: true # Create a home directory for the user
        home: /app
        system: true
        state: present
   
   - name: delete app directory
     find: 
       path: /app
       patterns: '*'
       recurse: yes

   - name: create app directory
     file:
       state: directory
       path: /app
   
   - name: download app code
     get_url:
       url: https://roboshop-artifacts.s3.amazonaws.com/cart-v3.zip
       dest: /app/cart-v3.zip

   - name: unzip the app code
     unarchive:
      src: /app/cart-v3.zip
      dest: /app/
      remote_src: yes
     
   - name: delete the cart zip file
     file:
       path: /app/cart-v3.zip
       state: absent
   
   - name: install dependencies
     community.general.npm:
      path: /app

   - name: copy cart service file
     copy:
       src: cart.service
       dest: /etc/systemd/system/cart.service

   - name: start cart service
     service:
       name: cart
       enabled: yes
       daemon_reload: yes
       state: started


